<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>King Bolete Environmental Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js">
        </script>
        <script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
<style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #8B4513;
        }
        
        h1 {
            color: #8B4513;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.2rem;
            font-style: italic;
        }
        
        .description {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #8B4513;
        }
        
        .container {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
		.graph-container {
			background-color: #fff;
			border-radius: 10px;
			padding: 15px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
			transition: transform 0.3s ease;
			width: 100%;
			max-width: 100%;
			overflow: hidden;
		}
        
        .graph-container:hover {
            transform: translateY(-5px);
        }

		.graph-container:has(#data-table) {
			max-height: none;
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}

		#data-table-container {
			overflow-y: auto;
			flex-grow: 1;
			max-height: 430px;
		}
        
        .graph-title {
            color: #8B4513;
            margin-bottom: 15px;
            font-size: 1.4rem;
            text-align: center;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .input-section {
            background-color: #fff;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .input-title {
            color: #8B4513;
            margin-bottom: 20px;
            font-size: 1.6rem;
        }
        
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .input-field {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #8B4513;
        }
        
        button {
            background-color: #8B4513;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #6B3410;
        }
        
        .map-container {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
            border: 1px solid #ddd;
        }
        
        .info-panel {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: none;
        }
        
        .info-panel.active {
            display: block;
        }
        
        .info-title {
            color: #8B4513;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        .info-content {
            line-height: 1.8;
        }
        
        .info-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #eee;
        }
        
        .info-label {
            font-weight: 600;
            color: #555;
            display: inline-block;
            width: 200px;
        }
        
        .link {
            color: #1a73e8;
            text-decoration: none;
            word-break: break-all;
        }
        
        .link:hover {
            text-decoration: underline;
        }
        
        .user-point {
            background-color: #FF6B6B !important;
            border-color: #FF3838 !important;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 15px;
            color: #8B4513;
            font-weight: 600;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>King Bolete Environmental Analysis</h1>
        <p class="subtitle">Visualizing the relationship between elevation, soil temperature, and seasonal patterns</p>
    </header>
    
    <div class="description">
        <p>This interactive dashboard explores environmental factors associated with King Bolete (Boletus edulis) observations in Washington State. The scatter plots below show relationships between elevation, soil temperature, and time of year. Click on any point to view detailed information about that observation.</p>
    </div>
    
    <div class="input-section">
        <h2 class="input-title">Add New Location Data</h2>
        <p>Enter coordinates manually or click on the map to select a location. The system will retrieve the 7-day average soil temperature and elevation data from the Open-Meteo Historical Weather API.</p>
        
		<div class="input-group">
			<div class="input-field" style="flex: 1 1 200px;">
				<label for="latitude">Latitude</label>
				<input type="number" id="latitude" step="any" placeholder="e.g., 46.744487" value="46.744487" style="width: 100%;">
			</div>
			
			<div class="input-field" style="flex: 1 1 200px;">
				<label for="longitude">Longitude</label>
				<input type="number" id="longitude" step="any" placeholder="e.g., -121.812952" value="-121.812952" style="width: 100%;">
			</div>
			
			<div class="input-field" style="flex: 1 1 200px;">
				<label for="date">Observation Date</label>
				<input type="date" id="date" style="width: 100%;">
			</div>
			
			<div class="input-field" style="flex: 1 1 200px;">
				<label>&nbsp;</label>
				<button id="fetch-data" style="width: 100%;">Get Soil Temperature & Elevation</button>
			</div>
		</div>
        
        <div class="map-container" id="map"></div>
        
        <div class="loading" id="loading">Fetching data from Open-Meteo API...</div>
    </div>
    
    <div class="container">
        <div class="graph-container">
            <h3 class="graph-title">Elevation vs Soil Temperature</h3>
            <div class="chart-wrapper">
                <canvas id="elevationTempChart"></canvas>
            </div>
        </div>
        
        <div class="graph-container">
            <h3 class="graph-title">Elevation vs Date</h3>
            <div class="chart-wrapper">
                <canvas id="elevationDateChart"></canvas>
            </div>
        </div>
        
        <div class="graph-container">
            <h3 class="graph-title">Soil Temperature vs Date</h3>
            <div class="chart-wrapper">
                <canvas id="tempDateChart"></canvas>
            </div>
        </div>
        
		<div class="graph-container">
			<h3 class="graph-title">Data Table</h3>
			<div id="data-table-container" style="overflow-x: auto;">
				<table id="data-table" style="width: 100%; border-collapse: collapse;">
					<thead>
						<tr style="background-color: #8B4513; color: white; position: sticky; top: 0;">
							<th style="padding: 10px; text-align: center;">Date</th>
							<th style="padding: 10px; text-align: center;">Elevation (ft)</th>
							<th style="padding: 10px; text-align: center;">Soil Temp (°F)</th>
							<th style="padding: 10px; text-align: center;">Coordinates</th>
						</tr>
					</thead>
					<tbody id="table-body">
						<!-- Data will be populated here -->
					</tbody>
				</table>
			</div>
		</div>
    </div>
    
    <div class="info-panel" id="info-panel">
        <h3 class="info-title">Observation Details</h3>
        <div class="info-content" id="info-content">
            <!-- Details will be populated here when a point is clicked -->
        </div>
    </div>
    
    <footer>
        <p>Data Sources: iNaturalist observations & Open-Meteo Historical Weather API</p>
        <p>Note: The Open-Meteo API provides soil temperature data with a spatial resolution of 9 km for recent years (IFS model) or 0.25° (~25 km) for historical data (ERA5 model).</p>
    </footer>
    <style>
        /* New styles for map controls */
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .view-options {
            display: flex;
            gap: 5px;
        }
        
        .view-options button {
            padding: 5px 10px;
            font-size: 12px;
            background: #f0f0f0;
			color: black;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .view-options button.active {
            background: #8B4513;
            color: white;
            border-color: #6B3410;
        }
        
        .slider-container {
            display: none;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
            margin-top: 5px;
        }

		.slider-container label {
		  display: block;
		  text-align: center;
		  font-weight: 600;
		  margin-bottom: 6px;
		}
        
        .slider-container.active {
            display: block;
        }
        
        .slider-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

		/* Custom styles for smaller noUiSlider handles */
		.noUi-handle {
			width: 12px !important;
			height: 12px !important;
			right: -6px !important;
			top: -4px !important;
			border: 1px solid #333;
			box-sizing: border-box;
		}

		.noUi-horizontal .noUi-handle {
			width: 16px !important;
			height: 16px !important;
			right: -8px !important;
			top: -5px !important;
		}

		.noUi-handle:before, .noUi-handle:after {
			display: none !important;
		}

		.noUi-connect {
			background-color: #8B4513 !important;
		}

		.noUi-target {
			background-color: #f0f0f0 !important;
			border: 1px solid #ddd !important;
			box-shadow: none !important;
		}

		.noUi-tooltip {
			font-size: 10px !important;
			padding: 2px 5px !important;
			background: #8B4513 !important;
			color: white !important;
			border: none !important;
			border-radius: 3px !important;
		}

		/* Adjust the slider height */
		.noUi-horizontal {
			height: 8px !important;
		}

		/* Make sure the handle is properly positioned */
		.noUi-horizontal .noUi-handle-lower {
			right: -7px !important;
		}

		.noUi-horizontal .noUi-handle-upper {
			right: -7px !important;
		}
        
        .fullscreen-btn {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
			color: black;
            padding: 5px 10px;
            border-radius: 3px;
            border: 1px solid #ddd;
            cursor: pointer;
            font-size: 12px;
        }
        
        .fullscreen-btn:hover {
            background: #f0f0f0;
        }
        
        /* Fullscreen styles */
        .map-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
        }
        
        .map-container.fullscreen .map-controls {
            top: 20px;
            right: 20px;
        }
        
        .map-container.fullscreen .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
        }

		/* Legend container styles */
		.legend-container {
			position: absolute;
			bottom: 50px;
			left: 10px;
			z-index: 1000;
			background: white;
			padding: 10px;
			border-radius: 5px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.2);
			display: none;
			max-width: 200px;
			font-size: 12px;
		}

		.legend-container.active {
			display: block;
		}

		.legend-title {
			font-weight: 600;
			margin-bottom: 8px;
			color: #333;
			text-align: center;
			border-bottom: 1px solid #eee;
			padding-bottom: 5px;
		}

		.legend-gradient {
			height: 20px;
			width: 100%;
			border-radius: 3px;
			margin-bottom: 8px;
			border: 1px solid #ddd;
		}

		.legend-labels {
			display: flex;
			justify-content: space-between;
			font-size: 10px;
			color: #555;
		}

		/* Month legend grid styles */
		.month-legend-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 4px;
			margin-top: 5px;
		}

		.month-legend-item {
			display: flex;
			align-items: center;
			padding: 2px;
			font-size: 10px;
		}

		.month-color-box {
			width: 12px;
			height: 12px;
			border-radius: 2px;
			margin-right: 4px;
			border: 1px solid rgba(0,0,0,0.1);
			flex-shrink: 0;
		}

		.month-label {
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			font-size: 9px;
		}
    </style>

    <script>
        // CSV data from the provided sample
const csvData = `Observation Link,Date,Coordinates,Elevation ft,7 Day Avg Soil Temp °F (7-28cm),Open-Meteo API,Open-Meteo URL
https://www.inaturalist.org/observations/2357076,2002-10-08,"46.744487, -121.812952",2822,48.6,https://archive-api.open-meteo.com/v1/archive?latitude=46.744487&longitude=-121.812952&start_date=2002-10-01&end_date=2002-10-08&daily=soil_temperature_7_to_28cm_mean&timezone=America%2FLos_Angeles&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch,https://open-meteo.com/en/docs/historical-weather-api?start_date=2002-10-01&end_date=2002-10-08&latitude=46.744487&longitude=-121.812952&timezone=America%2FLos_Angeles&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&daily=soil_temperature_7_to_28cm_mean&hourly
https://www.inaturalist.org/observations/3820171,2007-09-20,"48.3726814214, -121.7551386208",3402,49.7,https://archive-api.open-meteo.com/v1/archive?latitude=48.3726814214&longitude=-121.7551386208&start_date=2007-09-13&end_date=2007-09-20&daily=soil_temperature_7_to_28cm_mean&timezone=America%2FLos_Angeles&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch,https://open-meteo.com/en/docs/historical-weather-api?start_date=2007-09-13&end_date=2007-09-20&latitude=48.3726814214&longitude=-121.7551386208&timezone=America%2FLos_Angeles&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&daily=soil_temperature_7_to_28cm_mean&hourly
https://www.inaturalist.org/observations/9341579,2007-10-18,"46.9943815141, -124.1575069417",13,52.9,https://archive-api.open-meteo.com/v1/archive?latitude=46.9943815141&longitude=-124.1575069417&start_date=2007-10-11&end_date=2007-10-18&daily=soil_temperature_7_to_28cm_mean&timezone=America%2FLos_Angeles&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch,https://open-meteo.com/en/docs/historical-weather-api?start_date=2007-10-11&end_date=2007-10-18&latitude=46.9943815141&longitude=-124.1575069417&timezone=America%2FLos_Angeles&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&daily=soil_temperature_7_to_28cm_mean&hourly`;

		async function loadCSVData() {
			try {
				const response = await fetch('./csv/WA_King_Bolete_Soil_Temp.csv');
				
				if (!response.ok) {
					throw new Error(`Failed to load CSV file: ${response.status} ${response.statusText}`);
				}
				
				const csvText = await response.text();
				return csvText;
			} catch (error) {
				console.error('Error loading CSV file:', error);
				alert(`Error loading data file: ${error.message}\nUsing sample data instead.`);
				// Return the hardcoded sample data as fallback
				return csvData;
			}
		}

        // Parse CSV data
		function parseCSV(csv) {
			const lines = csv.split('\n');
			const headers = lines[0].split(',');
			
			const data = [];
			for (let i = 1; i < lines.length; i++) {
				if (lines[i].trim() === '') continue;
				
				const obj = {};
				let currentLine = lines[i];
				let insideQuotes = false;
				let field = '';
				let fields = [];
				let fieldIndex = 0;
				
				for (let j = 0; j < currentLine.length; j++) {
					const char = currentLine[j];
					
					if (char === '"') {
						insideQuotes = !insideQuotes;
					} else if (char === ',' && !insideQuotes) {
						fields.push(field);
						field = '';
						fieldIndex++;
					} else {
						field += char;
					}
				}
				fields.push(field);
				
				for (let j = 0; j < headers.length && j < fields.length; j++) {
					obj[headers[j].trim()] = fields[j].trim().replace(/^"|"$/g, '');
				}
				
				// Extract date information
				const date = new Date(obj.Date);
				obj.Month = date.getMonth() + 1; // 1-12 Jan-Dec
				obj.MonthName = date.toLocaleString('default', { month: 'short' });
				obj.MonthDay = date.getDate(); // Day of month (1-31)
				obj.YearMonth = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
				obj.MonthFraction = (date.getMonth() + 1) + (date.getDate() / 31); // 1-12 + day fraction
				
				// Extract lat/lng from coordinates
				const coords = obj.Coordinates.split(',').map(coord => parseFloat(coord.trim()));
				obj.Latitude = coords[0];
				obj.Longitude = coords[1];
				
				// Convert elevation and temperature to numbers
				obj['Elevation ft'] = parseFloat(obj['Elevation ft']);
				obj['7 Day Avg Soil Temp °F (7-28cm)'] = parseFloat(obj['7 Day Avg Soil Temp °F (7-28cm)']);
				
				data.push(obj);
			}
			
			return data;
		}

        // Initialize data
		let originalData = [];
		let userData = [];
		let allData = [];
        
        // Chart instances
        let elevationTempChart, elevationDateChart, tempDateChart;
        // Initialize map
        let map, marker, mapPoints = [];
        let currentView = 'default';
        let elevationRange = [0, 8000];
        let tempRange = [0, 100];
        let monthRange = [1, 12];
        
        // Color scales
		const elevationColorScale = d3.scaleLinear()
			.domain([0, 1333, 2666, 4000, 5333, 6666, 8000]) // Evenly distributed stops
			.range([
				'#6A0DAD', // Purple at 0 ft
				'#0000FF', // Blue at 1333 ft
				'#00FF00', // Green at 2666 ft
				'#FFFF00', // Yellow at 4000 ft
				'#FFA500', // Orange at 5333 ft
				'#FF4500', // Red-Orange at 6666 ft
				'#FF0000'  // Red at 8000 ft
			]);

		const tempColorScale = d3.scaleLinear()
			.domain([40, 60])
			.range(['#0000FF', '#FF0000']) // More contrast blue to red
			.interpolate(d3.interpolateHcl); // For smoother gradient

		// Updated month colors as smooth gradient from red-violet to red
		const monthColors = [
			'#FF6B6B', // Jan - Deep Red
			'#FF8E53', // Feb - Orange-Red
			'#FFB347', // Mar - Orange
			'#FFD166', // Apr - Yellow-Orange
			'#A8E6CF', // May - Light Green
			'#7BC8A4', // Jun - Green
			'#4ECDC4', // Jul - Teal
			'#45B7D1', // Aug - Light Blue
			'#6C5CE7', // Sep - Purple
			'#A29BFE', // Oct - Lavender
			'#DDA0DD', // Nov - Plum
			'#FFB6C1'  // Dec - Pink
		];
        
		function initMap() {
			map = L.map('map').setView([46.744487, -121.812952], 7);
			
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);
			
			// Add click event to map (but not on controls)
			map.on('click', function(e) {
				// Get the clicked element
				const clickedElement = e.originalEvent.target;
				
				// Check if click was on a control element
				const isControl = clickedElement.closest('.map-controls') || 
								 clickedElement.closest('.noUi-handle') ||
								 clickedElement.closest('.fullscreen-btn');
				
				if (!isControl) {
					document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
					document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
					
					// Update marker position
					if (marker) {
						map.removeLayer(marker);
					}
					marker = L.marker(e.latlng).addTo(map);
				}
			});
			
			// Create map controls
			const mapControls = L.control({position: 'topright'});
			mapControls.onAdd = function() {
				const div = L.DomUtil.create('div', 'map-controls');
				
				// Prevent map click events from bubbling through controls
				L.DomEvent.disableClickPropagation(div);
				
				// View options
				div.innerHTML = `
					<div class="view-options">
						<button class="active" data-view="default">Default</button>
						<button data-view="elevation">Elevation</button>
						<button data-view="temp">Soil Temp</button>
						<button data-view="month">Month</button>
					</div>
					<div id="elevation-slider" class="slider-container">
						<label>Elevation Range (ft)</label>
						<div id="elevation-slider-range" class="range-slider"></div>
						<div class="range-values">
							<span id="elevation-min">0</span>
							<span>-</span>
							<span id="elevation-max">8000</span>
						</div>
					</div>
					<div id="temp-slider" class="slider-container">
						<label>Soil Temp Range (°F)</label>
						<div id="temp-slider-range" class="range-slider"></div>
						<div class="range-values">
							<span id="temp-min">30</span>
							<span>-</span>
							<span id="temp-max">70</span>
						</div>
					</div>
					<div id="month-slider" class="slider-container">
						<label>Month Range</label>
						<div id="month-slider-range" class="range-slider"></div>
						<div class="range-values">
							<span id="month-min">Jan</span>
							<span>-</span>
							<span id="month-max">Dec</span>
						</div>
					</div>
				`;

				// Legend container
				const legendDiv = L.DomUtil.create('div', 'legend-container', map.getContainer());
				legendDiv.innerHTML = `
					<div class="legend-title">Color Legend</div>
					<div id="gradient-legend" class="legend-gradient"></div>
					<div class="legend-labels">
						<span id="legend-min">Min</span>
						<span id="legend-max">Max</span>
					</div>
					<div id="month-legend" class="month-legend-grid" style="display: none;">
						<!-- Month legend items will be populated here in 3x4 grid -->
					</div>
				`;
				L.DomEvent.disableClickPropagation(legendDiv);
				
				// Fullscreen button
				const fullscreenBtn = L.DomUtil.create('button', 'fullscreen-btn', map.getContainer());
				fullscreenBtn.textContent = 'Fullscreen';
				L.DomEvent.on(fullscreenBtn, 'click', toggleFullscreen);
				L.DomEvent.disableClickPropagation(fullscreenBtn);
				
				// View option click handlers
				div.querySelectorAll('.view-options button').forEach(btn => {
					btn.addEventListener('click', function() {
						div.querySelectorAll('.view-options button').forEach(b => b.classList.remove('active'));
						this.classList.add('active');
						currentView = this.dataset.view;
						
						// Update map points
						updateMapPoints();
						
						// Update legend immediately
						if (typeof updateMonthLegend === 'function') {
							updateMonthLegend();
						}
					});
				});
				
				return div;
			};
			
			mapControls.addTo(map);
			
			// Initialize sliders AFTER the control is added to the map
			setTimeout(() => {
				// Now the slider elements exist in the DOM
				window.elevationSlider = createRangeSlider('elevation-slider-range', 0, 8000, [0, 8000], 100);
				window.tempSlider = createRangeSlider('temp-slider-range', 30, 70, [30, 70], 1);
				window.monthSlider = createRangeSlider('month-slider-range', 1, 12, [1, 12], 1);
				window.elevationSlider.on('update', function(values) {
					elevationRange = values;
					document.getElementById('elevation-min').textContent = Math.round(values[0]);
					document.getElementById('elevation-max').textContent = Math.round(values[1]);
					updateMapPoints();
				});
				
				window.tempSlider.on('update', function(values) {
					tempRange = values;
					document.getElementById('temp-min').textContent = Math.round(values[0]);
					document.getElementById('temp-max').textContent = Math.round(values[1]);
					updateMapPoints();
				});
				
				window.monthSlider.on('update', function(values) {
					monthRange = values.map(v => Math.round(v));
					updateMonthLabels();
					updateMapPoints();
				});

				// Also keep the change event for final updates
				window.elevationSlider.on('change', function(values) {
					elevationRange = values;
					document.getElementById('elevation-min').textContent = Math.round(values[0]);
					document.getElementById('elevation-max').textContent = Math.round(values[1]);
				});
				
				window.tempSlider.on('change', function(values) {
					tempRange = values;
					document.getElementById('temp-min').textContent = Math.round(values[0]);
					document.getElementById('temp-max').textContent = Math.round(values[1]);
				});
				
				window.monthSlider.on('change', function(values) {
					monthRange = values.map(v => Math.round(v));
					updateMonthLabels();
				});
// Ensure default view is displayed on page load
				updateMapPoints();
				
			}, 100);
		}
        
		// Function to trigger slider update when switching views
		function triggerSliderUpdate() {
			switch(currentView) {
				case 'elevation':
					// Trigger elevation slider change event
					if (window.elevationSlider) {
						const values = window.elevationSlider.get();
						window.elevationSlider.set(values);
					}
					break;
				case 'temp':
					// Trigger temperature slider change event
					if (window.tempSlider) {
						const values = window.tempSlider.get();
						window.tempSlider.set(values);
					}
					break;
				case 'month':
					// Trigger month slider change event
					if (window.monthSlider) {
						const values = window.monthSlider.get();
						window.monthSlider.set(values);
					}
					break;
			}
		}

		function updateMonthLabels() {
			const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
						   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
			
			const minMonthElem = document.getElementById('month-min');
			const maxMonthElem = document.getElementById('month-max');
			
			if (minMonthElem && maxMonthElem) {
				minMonthElem.textContent = months[monthRange[0] - 1] || 'Jan';
				maxMonthElem.textContent = months[monthRange[1] - 1] || 'Dec';
			}
		}
        // Create range slider with two handles
        function createRangeSlider(id, min, max, values, step) {
            const slider = noUiSlider.create(document.getElementById(id), {
                start: values,
                connect: true,
                step: step,
                range: {
                    'min': min,
                    'max': max
                },
                behaviour: 'drag',
                tooltips: true,
                format: {
                    to: function(value) {
                        return Math.round(value);
                    },
                    from: function(value) {
                        return Number(value);
                    }
                }
            });
            return slider;
        }

		function updateMapPoints() {
			// Show/hide legend based on current view
			const legendContainer = document.querySelector('.legend-container');
			const gradientLegend = document.getElementById('gradient-legend');
			const monthLegend = document.getElementById('month-legend');
			const legendMin = document.getElementById('legend-min');
			const legendMax = document.getElementById('legend-max');
			
			if (legendContainer) {
				legendContainer.classList.toggle('active', 
					currentView === 'elevation' || currentView === 'temp' || currentView === 'month');
			}
			
			// Update legend content based on current view
			if (gradientLegend && legendMin && legendMax) {
				const legendLabels = document.querySelector('.legend-labels');
				
				switch(currentView) {
					case 'elevation':
						gradientLegend.style.display = 'block';
						monthLegend.style.display = 'none';
						if (legendLabels) legendLabels.style.display = 'flex';
						gradientLegend.style.background = 'linear-gradient(to right, #6A0DAD, #0000FF, #00FF00, #FFFF00, #FFA500, #FF0000)';
						legendMin.textContent = '0 ft';
						legendMax.textContent = '8000 ft';
						// Reset width
						if (legendContainer) {
							legendContainer.style.maxWidth = '200px';
						}
						break;
						
					case 'temp':
						gradientLegend.style.display = 'block';
						monthLegend.style.display = 'none';
						if (legendLabels) legendLabels.style.display = 'flex';
						gradientLegend.style.background = 'linear-gradient(to right, #0000FF, #FF0000)';
						legendMin.textContent = '30°F';
						legendMax.textContent = '70°F';
						// Reset width
						if (legendContainer) {
							legendContainer.style.maxWidth = '200px';
						}
						break;
						
					case 'month':
						gradientLegend.style.display = 'none';
						monthLegend.style.display = 'grid';
						// Hide the legend labels (min/max)
						if (legendLabels) legendLabels.style.display = 'none';
						// Adjust legend container width for grid layout
						if (legendContainer) {
							legendContainer.style.maxWidth = '180px'; // Slightly wider for grid
						}
						break;
						
					default:
						if (gradientLegend) gradientLegend.style.display = 'block';
						if (monthLegend) monthLegend.style.display = 'none';
						if (legendLabels) legendLabels.style.display = 'flex';
						if (legendMin) legendMin.textContent = 'Min';
						if (legendMax) legendMax.textContent = 'Max';
				}
			}
			// Clear existing points
			mapPoints.forEach(point => map.removeLayer(point));
			mapPoints = [];
			
			// Ensure currentView is set (in case it's undefined on first load)
			if (!currentView) {
				currentView = 'default';
			}
			
			// Show/hide sliders based on current view
			const elevationSlider = document.getElementById('elevation-slider');
			const tempSlider = document.getElementById('temp-slider');
			const monthSlider = document.getElementById('month-slider');
			
			if (elevationSlider) elevationSlider.classList.toggle('active', currentView === 'elevation');
			if (tempSlider) tempSlider.classList.toggle('active', currentView === 'temp');
			if (monthSlider) monthSlider.classList.toggle('active', currentView === 'month');
			
			// Get current slider values when switching views
			if (currentView === 'elevation' && window.elevationSlider) {
				const values = window.elevationSlider.get();
				elevationRange = values.map(v => parseFloat(v));
			} else if (currentView === 'temp' && window.tempSlider) {
				const values = window.tempSlider.get();
				tempRange = values.map(v => parseFloat(v));
			} else if (currentView === 'month' && window.monthSlider) {
				const values = window.monthSlider.get();
				monthRange = values.map(v => Math.round(parseFloat(v)));
				updateMonthLabels();
			}
			
			// If not in a filtered view, use default ranges
			if (currentView !== 'elevation') elevationRange = [0, 8000];
			if (currentView !== 'temp') tempRange = [30, 70];
			if (currentView !== 'month') monthRange = [1, 12];
originalData.forEach(point => {
                // Filter based on ranges
                const inElevationRange = point['Elevation ft'] >= elevationRange[0] && 
                                      point['Elevation ft'] <= elevationRange[1];
                const inTempRange = point['7 Day Avg Soil Temp °F (7-28cm)'] >= tempRange[0] && 
                                 point['7 Day Avg Soil Temp °F (7-28cm)'] <= tempRange[1];
                const inMonthRange = point.Month >= monthRange[0] && 
                                  point.Month <= monthRange[1];
                
                if (!inElevationRange || !inTempRange || !inMonthRange) return;
                
                // Set color based on current view
                let color, fillColor;
                
                switch(currentView) {
                    case 'elevation':
                        color = elevationColorScale(point['Elevation ft']);
                        fillColor = color;
                        break;
                    case 'temp':
                        color = tempColorScale(point['7 Day Avg Soil Temp °F (7-28cm)']);
                        fillColor = color;
                        break;
                    case 'month':
                        color = monthColors[point.Month - 1];
                        fillColor = color;
                        break;
                    default:
                        color = '#8B4513';
                        fillColor = '#8B4513';
                }
                
                const marker = L.circleMarker([point.Latitude, point.Longitude], {
                    radius: 3,
                    color: color,
                    fillColor: fillColor,
                    fillOpacity: 0.8,
                    weight: 1
                }).addTo(map);
                
                marker.on('click', () => showPointInfo(point));
                mapPoints.push(marker);
            });
        }
        
		function updateMonthLegend() {
			const monthLegend = document.getElementById('month-legend');
			if (!monthLegend) return;
			
			const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
						   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
			
			let legendHTML = '';
			monthColors.forEach((color, index) => {
				legendHTML += `
					<div class="month-legend-item">
						<div class="month-color-box" style="background-color: ${color};"></div>
						<div class="month-label">${months[index]}</div>
					</div>
				`;
			});
			
			monthLegend.innerHTML = legendHTML;
		}

		function toggleFullscreen() {
			const mapContainer = document.querySelector('.map-container');
			
			if (!document.fullscreenElement) {
				mapContainer.classList.add('fullscreen');
				if (mapContainer.requestFullscreen) {
					mapContainer.requestFullscreen();
				}
				map.invalidateSize();
			} else {
				exitFullscreen();
			}
		}

		// New function to handle exiting fullscreen
		function exitFullscreen() {
			const mapContainer = document.querySelector('.map-container');
			
			if (document.exitFullscreen) {
				document.exitFullscreen();
			}
			mapContainer.classList.remove('fullscreen');
			map.invalidateSize();
		}

		// Add event listener for fullscreen change (including ESC key)
		document.addEventListener('fullscreenchange', function() {
			const mapContainer = document.querySelector('.map-container');
			
			if (!document.fullscreenElement && mapContainer.classList.contains('fullscreen')) {
				// User pressed ESC or otherwise exited fullscreen
				mapContainer.classList.remove('fullscreen');
				map.invalidateSize();
			}
		});

		// Also handle other vendor prefixes for fullscreen API
		document.addEventListener('webkitfullscreenchange', function() {
			const mapContainer = document.querySelector('.map-container');
			
			if (!document.webkitFullscreenElement && mapContainer.classList.contains('fullscreen')) {
				mapContainer.classList.remove('fullscreen');
				map.invalidateSize();
			}
		});

		document.addEventListener('mozfullscreenchange', function() {
			const mapContainer = document.querySelector('.map-container');
			
			if (!document.mozFullScreenElement && mapContainer.classList.contains('fullscreen')) {
				mapContainer.classList.remove('fullscreen');
				map.invalidateSize();
			}
		});

		document.addEventListener('MSFullscreenChange', function() {
			const mapContainer = document.querySelector('.map-container');
			
			if (!document.msFullscreenElement && mapContainer.classList.contains('fullscreen')) {
				mapContainer.classList.remove('fullscreen');
				map.invalidateSize();
			}
		});
		// Initialize charts
		function initCharts() {
			const ctx1 = document.getElementById('elevationTempChart').getContext('2d');
			const ctx2 = document.getElementById('elevationDateChart').getContext('2d');
			const ctx3 = document.getElementById('tempDateChart').getContext('2d');
			
			// Common chart configuration
			const commonOptions = {
				responsive: true,
				maintainAspectRatio: false,
				onClick: (evt, elements) => {
					if (elements.length > 0) {
						const index = elements[0].index;
						const datasetIndex = elements[0].datasetIndex;
						
						// Determine which dataset was clicked
						let dataPoint;
						if (datasetIndex === 0) {
							dataPoint = originalData[index];
						} else if (datasetIndex === 1 && userData.length > 0) {
							dataPoint = userData[0];
						}
						
						if (dataPoint) {
							showPointInfo(dataPoint);
						}
					}
				},
				plugins: {
					legend: {
						display: true,
						position: 'top',
						align: 'center',
						labels: {
							boxWidth: 12,
							padding: 15,
							font: {
								size: 12,
								family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
							},
							usePointStyle: true,
							pointStyle: 'circle',
							color: '#333'
						}
					},
					tooltip: {
						callbacks: {
							label: function(context) {
								const dataPoint = context.datasetIndex === 0 ? 
									originalData[context.dataIndex] : 
									userData[0];
									
								return [
									`Date: ${dataPoint.Date || 'N/A'}`,
									`Elevation: ${dataPoint['Elevation ft']} ft`,
									`Soil Temp: ${dataPoint['7 Day Avg Soil Temp °F (7-28cm)']} °F`,
									`Coordinates: ${dataPoint.Coordinates}`
								];
							}
						}
					}
				}
			};
			
			// Chart 1: Elevation vs Soil Temperature
			elevationTempChart = new Chart(ctx1, {
				type: 'scatter',
				data: {
					datasets: [
						{
							label: 'Original Data',
							data: originalData.map(point => ({
								x: point['7 Day Avg Soil Temp °F (7-28cm)'],
								y: point['Elevation ft']
							})),
							backgroundColor: 'rgba(139, 69, 19, 0.7)',
							borderColor: 'rgba(139, 69, 19, 1)',
							borderWidth: 1,
							pointRadius: 3,
							pointHoverRadius: 4,
							order: 2,
							z: 1
						},
						{
							label: 'Your Added Point',
							data: [], // Initially empty
							backgroundColor: '#FF6B6B',
							borderColor: '#FF3838',
							borderWidth: 3,
							pointRadius: 6,
							pointHoverRadius: 7,
							order: 1,
							z: 2
						}
					]
				},
				options: {
					...commonOptions,
					scales: {
						x: {
							title: {
								display: true,
								text: '7 Day Avg Soil Temp °F (7-28cm)',
								font: {
									weight: 'bold'
								}
							},
							grid: {
								color: 'rgba(0, 0, 0, 0.05)'
							}
						},
						y: {
							title: {
								display: true,
								text: 'Elevation ft',
								font: {
									weight: 'bold'
								}
							},
							min: 0,
							max: 8000,
							grid: {
								color: 'rgba(0, 0, 0, 0.05)'
							}
						}
					}
				}
			});
			
			// Chart 2: Elevation vs Date (by Month with day precision)
			elevationDateChart = new Chart(ctx2, {
				type: 'scatter',
				data: {
					datasets: [
						{
							label: 'Original Data',
							data: originalData.map(point => ({
								x: point.MonthFraction,
								y: point['Elevation ft']
							})),
							backgroundColor: 'rgba(139, 69, 19, 0.7)',
							borderColor: 'rgba(139, 69, 19, 1)',
							borderWidth: 1,
							pointRadius: 3,
							pointHoverRadius: 4,
							order: 2,
							z: 1
						},
						{
							label: 'Your Added Point',
							data: [], // Initially empty
							backgroundColor: '#FF6B6B',
							borderColor: '#FF3838',
							borderWidth: 3,
							pointRadius: 6,
							pointHoverRadius: 7,
							order: 1,
							z: 2
						}
					]
				},
				options: {
					...commonOptions,
					scales: {
						x: {
							type: 'linear',
							title: {
								display: true,
								text: 'Month',
								font: {
									weight: 'bold'
								}
							},
							min: 1,
							max: 13,
							ticks: {
								callback: function(value) {
									const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
												  'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
									const monthIndex = Math.floor(value) - 1;
									if (monthIndex >= 0 && monthIndex < 12) {
										return months[monthIndex];
									}
									return '';
								},
								stepSize: 1
							},
							grid: {
								color: 'rgba(0, 0, 0, 0.05)'
							}
						},
						y: {
							title: {
								display: true,
								text: 'Elevation ft',
								font: {
									weight: 'bold'
								}
							},
							min: 0,
							max: 8000,
							grid: {
								color: 'rgba(0, 0, 0, 0.05)'
							}
						}
					}
				}
			});
			
			// Chart 3: Soil Temperature vs Date (by Month with day precision)
			tempDateChart = new Chart(ctx3, {
				type: 'scatter',
				data: {
					datasets: [
						{
							label: 'Original Data',
							data: originalData.map(point => ({
								x: point.MonthFraction,
								y: point['7 Day Avg Soil Temp °F (7-28cm)']
							})),
							backgroundColor: 'rgba(139, 69, 19, 0.7)',
							borderColor: 'rgba(139, 69, 19, 1)',
							borderWidth: 1,
							pointRadius: 3,
							pointHoverRadius: 4,
							order: 2,
							z: 1
						},
						{
							label: 'Your Added Point',
							data: [], // Initially empty
							backgroundColor: '#FF6B6B',
							borderColor: '#FF3838',
							borderWidth: 3,
							pointRadius: 6,
							pointHoverRadius: 7,
							order: 1,
							z: 2
						}
					]
				},
				options: {
					...commonOptions,
					scales: {
						x: {
							type: 'linear',
							title: {
								display: true,
								text: 'Month',
								font: {
									weight: 'bold'
								}
							},
							min: 1,
							max: 13,
							ticks: {
								callback: function(value) {
									const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
												  'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
									const monthIndex = Math.floor(value) - 1;
									if (monthIndex >= 0 && monthIndex < 12) {
										return months[monthIndex];
									}
									return '';
								},
								stepSize: 1
							},
							grid: {
								color: 'rgba(0, 0, 0, 0.05)'
							}
						},
						y: {
							title: {
								display: true,
								text: '7 Day Avg Soil Temp °F (7-28cm)',
								font: {
									weight: 'bold'
								}
							},
							grid: {
								color: 'rgba(0, 0, 0, 0.05)'
							}
						}
					}
				}
			});
			
			// Populate data table
			populateDataTable();
		}
        
        // Populate data table
        function populateDataTable() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            allData.forEach(point => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #eee';
                row.style.cursor = 'pointer';
                
                row.onclick = function() {
                    showPointInfo(point);
                };
                
                // Highlight user-added data
                if (userData.includes(point)) {
                    row.style.backgroundColor = '#FFF5F5';
                }
                
                row.innerHTML = `
                    <td style="padding: 10px; text-align: center;">${point.Date}</td>
                    <td style="padding: 10px; text-align: center;">${point['Elevation ft']}</td>
                    <td style="padding: 10px; text-align: center;">${point['7 Day Avg Soil Temp °F (7-28cm)']}</td>
                    <td style="padding: 10px; text-align: center;">${point.Coordinates}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Show point information in the info panel
        function showPointInfo(point) {
            const infoPanel = document.getElementById('info-panel');
            const infoContent = document.getElementById('info-content');
            
            // Create observation link if not present (for user-added points)
            const observationLink = point['Observation Link'] || '#';
            
            // Create Open-Meteo URLs based on the information from the URLs
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            
            const startDate = point.Date ? 
                new Date(new Date(point.Date).getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] : 
                weekAgo.toISOString().split('T')[0];
            const endDate = point.Date || today.toISOString().split('T')[0];
            
            const openMeteoApiUrl = `https://archive-api.open-meteo.com/v1/archive?latitude=${point.Latitude}&longitude=${point.Longitude}&start_date=${startDate}&end_date=${endDate}&daily=soil_temperature_7_to_28cm_mean&timezone=America%2FLos_Angeles&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch`;
            
            const openMeteoDocsUrl = `https://open-meteo.com/en/docs/historical-weather-api?start_date=${startDate}&end_date=${endDate}&latitude=${point.Latitude}&longitude=${point.Longitude}&timezone=America%2FLos_Angeles&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&daily=soil_temperature_7_to_28cm_mean&hourly`;
            
            infoContent.innerHTML = `
                <div class="info-item">
                    <span class="info-label">Date:</span> ${point.Date || 'N/A'}
                </div>
                <div class="info-item">
                    <span class="info-label">Coordinates:</span> ${point.Coordinates}
                </div>
                <div class="info-item">
                    <span class="info-label">Elevation:</span> ${point['Elevation ft']} ft
                </div>
                <div class="info-item">
                    <span class="info-label">7-Day Avg Soil Temp:</span> ${point['7 Day Avg Soil Temp °F (7-28cm)']} °F
                </div>
                <div class="info-item">
                    <span class="info-label">Observation Link:</span> 
                    <a href="${observationLink}" target="_blank" class="link">${observationLink}</a>
                </div>
                <div class="info-item">
                    <span class="info-label">Open-Meteo API URL:</span> 
                    <a href="${openMeteoApiUrl}" target="_blank" class="link">${openMeteoApiUrl}</a>
                </div>
                <div class="info-item">
                    <span class="info-label">Open-Meteo Documentation:</span> 
                    <a href="${openMeteoDocsUrl}" target="_blank" class="link">${openMeteoDocsUrl}</a>
                </div>
            `;
            
            infoPanel.classList.add('active');
            
            // Scroll to info panel
            infoPanel.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Fetch data from Open-Meteo API
		async function fetchOpenMeteoData(latitude, longitude, date) {
			const loadingDiv = document.getElementById('loading');
			loadingDiv.style.display = 'block';
			
			try {
				// Calculate start date (7 days before the observation date)
				const observationDate = new Date(date);
				const startDate = new Date(observationDate);
				startDate.setDate(observationDate.getDate() - 7);
				
				// Format dates for API
				const startDateStr = startDate.toISOString().split('T')[0];
				const endDateStr = observationDate.toISOString().split('T')[0];
				
				// Build API URL
				const apiUrl = `https://archive-api.open-meteo.com/v1/archive?latitude=${latitude}&longitude=${longitude}&start_date=${startDateStr}&end_date=${endDateStr}&daily=soil_temperature_7_to_28cm_mean&timezone=America%2FLos_Angeles&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch`;
				
				const response = await fetch(apiUrl);
				
				if (!response.ok) {
					throw new Error(`API error: ${response.status}`);
				}
				
				const data = await response.json();
				
				// Calculate 7-day average soil temperature
				const soilTemps = data.daily.soil_temperature_7_to_28cm_mean;
				const avgSoilTemp = soilTemps.reduce((sum, temp) => sum + temp, 0) / soilTemps.length;
				
				// Get elevation from API response
				const elevation = data.elevation;
				
				// Convert elevation from meters to feet (1 meter = 3.28084 feet)
				const elevationFt = elevation * 3.28084;
				
				// Extract date components
				const dayOfMonth = observationDate.getDate();
				const monthFraction = observationDate.getMonth() + (dayOfMonth / 31);
				
				// Create new data point
				const newPoint = {
					'Observation Link': '#',
					'Date': endDateStr,
					'Coordinates': `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`,
					'Elevation ft': Math.round(elevationFt),
					'7 Day Avg Soil Temp °F (7-28cm)': parseFloat(avgSoilTemp.toFixed(1)),
					'Open-Meteo API': apiUrl,
					'Open-Meteo URL': `https://open-meteo.com/en/docs/historical-weather-api?start_date=${startDateStr}&end_date=${endDateStr}&latitude=${latitude}&longitude=${longitude}&timezone=America%2FLos_Angeles&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&daily=soil_temperature_7_to_28cm_mean&hourly`,
					'Latitude': latitude,
					'Longitude': longitude,
					'Month': observationDate.getMonth() + 1,
					'MonthName': observationDate.toLocaleString('default', { month: 'short' }),
					'MonthDay': dayOfMonth,
					'YearMonth': observationDate.getFullYear() + '-' + 
								String(observationDate.getMonth() + 1).padStart(2, '0'),
					'MonthFraction': (observationDate.getMonth() + 1) + (dayOfMonth / 31)
				};
				
				// Clear previous user data and add new point
				userData = [newPoint];
				allData = [...originalData, ...userData];
				
				// Update charts with new data
				updateCharts();
				
				// Update map with new marker
				if (marker) {
					map.removeLayer(marker);
				}
				marker = L.marker([latitude, longitude], {
					icon: L.divIcon({
						className: 'user-marker',
						html: '<div style="background-color: #FF6B6B; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.5);"></div>',
						iconSize: [10, 10]
					})
				}).addTo(map);
				
				// Show info for the new point
				showPointInfo(newPoint);
				
			} catch (error) {
				console.error('Error fetching Open-Meteo data:', error);
				alert(`Error fetching data: ${error.message}\n\nNote: The Open-Meteo API may not have data for the selected date range or location. Try a different date or coordinates.`);
			} finally {
				loadingDiv.style.display = 'none';
			}
		}
        
        // Update charts with new data
		function updateCharts() {
			if (userData.length > 0) {
				const userPoint = userData[0];
				
				// Update Chart 1: Elevation vs Soil Temperature
				elevationTempChart.data.datasets[1].data = [{
					x: userPoint['7 Day Avg Soil Temp °F (7-28cm)'],
					y: userPoint['Elevation ft']
				}];
				
				// Update Chart 2: Elevation vs Date
				elevationDateChart.data.datasets[1].data = [{
					x: userPoint.MonthFraction,
					y: userPoint['Elevation ft']
				}];
				
				// Update Chart 3: Soil Temperature vs Date
				tempDateChart.data.datasets[1].data = [{
					x: userPoint.MonthFraction,
					y: userPoint['7 Day Avg Soil Temp °F (7-28cm)']
				}];
			} else {
				// Clear user data if empty
				elevationTempChart.data.datasets[1].data = [];
				elevationDateChart.data.datasets[1].data = [];
				tempDateChart.data.datasets[1].data = [];
			}
			
			// Update all charts
			elevationTempChart.update();
			elevationDateChart.update();
			tempDateChart.update();
			
			// Update data table
			populateDataTable();
		}
        
        // Initialize the application
		document.addEventListener('DOMContentLoaded', async function() {
			try {
				// Load CSV data from file
				const csvText = await loadCSVData();
				originalData = parseCSV(csvText);
				allData = [...originalData];
				
				// Initialize the rest of the application
				initMap();
				initCharts();
				
				// Add event listener for the fetch data button
				document.getElementById('fetch-data').addEventListener('click', function() {
					const latitude = parseFloat(document.getElementById('latitude').value);
					const longitude = parseFloat(document.getElementById('longitude').value);
					const date = document.getElementById('date').value;
					
					if (isNaN(latitude) || isNaN(longitude)) {
						alert('Please enter valid latitude and longitude values.');
						return;
					}
					
					if (!date) {
						alert('Please select a date.');
						return;
					}
					
					fetchOpenMeteoData(latitude, longitude, date);
				});
				
				// Add event listener for Enter key in input fields
				document.getElementById('latitude').addEventListener('keypress', function(e) {
					if (e.key === 'Enter') {
						document.getElementById('fetch-data').click();
					}
				});
				
				document.getElementById('longitude').addEventListener('keypress', function(e) {
					if (e.key === 'Enter') {
						document.getElementById('fetch-data').click();
					}
				});
				
				// Set default date to current date
				const today = new Date();
				const todayFormatted = today.toISOString().split('T')[0];
				document.getElementById('date').value = todayFormatted;
				updateMonthLegend();
				
				// Force an initial update of the map points to ensure default view is displayed
				setTimeout(() => {
					if (typeof updateMapPoints === 'function') {
						updateMapPoints();
					}
				}, 200); // Give everything time to initialize
				
			} catch (error) {
				console.error('Error initializing application:', error);
				alert('Error loading data. Please check if the CSV file exists at ./csv/WA_King_Bolete_Soil_Temp.csv');
			}
		});
    </script>
</body>
</html>